<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Studio AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #E2E8F0;
        }
        .glassmorphism {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-primary {
            background-image: linear-gradient(to right, #8B5CF6, #6366F1);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6);
        }
        .btn-secondary {
            background-color: #334155;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        .btn-selected {
            background-color: #4F46E5 !important;
            color: #FFFFFF !important;
            border-color: #4F46E5 !important;
        }
        .drop-zone {
            border: 2px dashed #475569;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .drop-zone.dragover {
            background-color: #1E293B;
            border-color: #4F46E5;
        }
        .loader {
            border: 4px solid #334155;
            border-top: 4px solid #4F46E5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto flex flex-col items-center">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Creator Studio AI</h1>
            <p class="text-slate-400 mt-2">by <a href="#" class="text-indigo-400">Sosmeurus</a></p>
            <p class="text-slate-300 mt-2 max-w-2xl">Wujudkan imajinasimu. Buat foto produk profesional dan poster sinematik dalam sekejap.</p>
        </div>

        <div class="w-full grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Kolom Kontrol Kiri -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div class="glassmorphism p-6 rounded-lg space-y-4">
                    <h3 class="font-semibold text-white">1. Pilih Mode Kreasi</h3>
                    <div id="creation-mode" class="grid grid-cols-3 gap-2">
                        <button data-mode="product-photo" class="mode-btn text-xs py-2 px-1 border border-slate-600 rounded-md bg-slate-700 hover:bg-slate-600 transition">Foto Produk</button>
                        <button data-mode="poster-design" class="mode-btn text-xs py-2 px-1 border border-slate-600 rounded-md bg-slate-700 hover:bg-slate-600 transition">Poster / Desain</button>
                        <button data-mode="mockup-packaging" class="mode-btn text-xs py-2 px-1 border border-slate-600 rounded-md bg-slate-700 hover:bg-slate-600 transition">Mockup Packaging</button>
                    </div>
                </div>

                <div class="glassmorphism p-6 rounded-lg space-y-4">
                     <h3 class="font-semibold text-white">2. Upload Aset Visual (Wajib)</h3>
                    <div id="drop-zone" class="drop-zone rounded-lg p-8 text-center cursor-pointer">
                        <div id="upload-prompt">
                            <svg class="mx-auto h-12 w-12 text-slate-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4V12a4 4 0 014-4h12m16 0h-4.382a2 2 0 01-1.414-.586l-2.204-2.204A2 2 0 0028.586 4H19.414a2 2 0 00-1.414.586l-2.204 2.204A2 2 0 0114.382 8H10a4 4 0 00-4 4v20a4 4 0 004 4h28a4 4 0 004-4V12a4 4 0 00-4-4z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <p class="mt-2 text-sm text-slate-400">Klik atau seret foto ke sini</p>
                        </div>
                        <div id="preview-container" class="hidden">
                            <img id="image-preview" src="" class="max-h-24 mx-auto rounded-md"/>
                            <p id="filename-preview" class="text-xs text-slate-500 mt-2 truncate"></p>
                        </div>
                    </div>
                    <input type="file" id="file-input" class="hidden" accept="image/*">
                    
                    <div>
                        <label class="text-sm font-medium text-slate-300">Fokus AI</label>
                        <div id="ai-focus" class="grid grid-cols-3 gap-2 mt-2">
                             <button data-focus="packaging" class="focus-btn text-xs py-2 px-1 border border-slate-600 rounded-md bg-slate-700 hover:bg-slate-600 transition">Kemasan</button>
                             <button data-focus="product" class="focus-btn text-xs py-2 px-1 border border-slate-600 rounded-md bg-slate-700 hover:bg-slate-600 transition">Isi Produk</button>
                             <button data-focus="both" class="focus-btn text-xs py-2 px-1 border border-slate-600 rounded-md bg-slate-700 hover:bg-slate-600 transition">Kemasan & Isi</button>
                        </div>
                    </div>
                </div>

                <div class="glassmorphism p-6 rounded-lg space-y-4">
                    <h3 class="font-semibold text-white">3. Deskripsikan Imajinasimu</h3>
                    <div class="relative">
                        <textarea id="description" rows="4" class="w-full bg-slate-800 border border-slate-600 rounded-md p-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Permukaan Marmer"></textarea>
                        <button id="idea-btn" class="absolute top-2 right-2 text-xs text-indigo-400 hover:text-indigo-300">Beri Ide âœ¨</button>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">Coba tambahkan gaya:</label>
                        <div id="style-suggestions" class="flex flex-wrap gap-2 mt-2">
                            <button class="style-btn text-xs py-1 px-2 border border-slate-600 rounded-full bg-slate-700 hover:bg-slate-600 transition">Pencahayaan Dramatis</button>
                            <button class="style-btn text-xs py-1 px-2 border border-slate-600 rounded-full bg-slate-700 hover:bg-slate-600 transition">Palet Warna Pastel</button>
                            <button class="style-btn text-xs py-1 px-2 border border-slate-600 rounded-full bg-slate-700 hover:bg-slate-600 transition">Gaya Retro</button>
                            <button class="style-btn text-xs py-1 px-2 border border-slate-600 rounded-full bg-slate-700 hover:bg-slate-600 transition">Minimalis Modern</button>
                        </div>
                    </div>
                </div>

                <div class="glassmorphism p-6 rounded-lg space-y-4">
                    <h3 class="font-semibold text-white">4. Pilih Rasio Aspek</h3>
                    <div id="aspect-ratio" class="grid grid-cols-4 gap-2">
                        <button data-ratio="1:1" class="ratio-btn aspect-[1/1] border-2 border-slate-600 rounded-md bg-slate-700 flex items-center justify-center text-xs flex-col hover:border-indigo-500 transition btn-selected">1:1</button>
                        <button data-ratio="4:5" class="ratio-btn aspect-[4/5] border-2 border-slate-600 rounded-md bg-slate-700 flex items-center justify-center text-xs flex-col hover:border-indigo-500 transition">4:5</button>
                        <button data-ratio="9:16" class="ratio-btn aspect-[9/16] border-2 border-slate-600 rounded-md bg-slate-700 flex items-center justify-center text-xs flex-col hover:border-indigo-500 transition">9:16</button>
                        <button data-ratio="16:9" class="ratio-btn aspect-[16/9] border-2 border-slate-600 rounded-md bg-slate-700 flex items-center justify-center text-xs flex-col hover:border-indigo-500 transition">16:9</button>
                    </div>
                </div>

                <button id="generate-btn" class="w-full btn-primary text-white font-semibold py-3 rounded-lg shadow-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 0 0 .95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 0 0-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 0 0-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 0 0-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 0 0 .951-.69l1.07-3.292z"></path></svg>
                    Wujudkan Sekarang
                </button>
            </div>

            <!-- Kolom Hasil Kanan -->
            <div class="lg:col-span-2 glassmorphism rounded-lg p-6 min-h-[600px] flex flex-col justify-center items-center">
                <div id="result-container" class="w-full h-full flex flex-col justify-center items-center text-center">
                     <!-- Initial State -->
                    <div id="initial-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-slate-600 mx-auto"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 0 0 .95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 0 0-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 0 0-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 0 0-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 0 0 .951-.69l1.07-3.292z"></path></svg>
                        <h3 class="text-xl font-bold text-white mt-4">Hasil Kreasimu Muncul Disini</h3>
                        <p class="text-slate-400 mt-2">Atur panel kontrol untuk memulai keajaiban.</p>
                    </div>
                    <!-- Loading State -->
                    <div id="loading-state" class="hidden text-center">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4 text-slate-300 animate-pulse">AI sedang meracik keajaiban...</p>
                        <p id="loading-details" class="text-sm text-slate-500 mt-1"></p>
                    </div>
                    <!-- Error State -->
                    <div id="error-state" class="hidden text-center w-full max-w-lg">
                        <div class="glassmorphism border border-red-500/30 p-6 rounded-lg">
                            <h4 class="font-bold text-red-400">Oops! Terjadi kesalahan.</h4>
                            <p id="error-message" class="text-sm text-slate-300 mt-2"></p>
                            <!-- Tombol Coba Lagi akan ditambahkan di sini oleh JavaScript -->
                        </div>
                    </div>
                    <!-- Result State -->
                    <div id="result-state" class="hidden w-full h-full">
                        <img id="result-image" src="" class="w-full h-auto object-contain rounded-lg max-h-[80vh]">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        const state = {
            creationMode: null,
            aiFocus: null,
            aspectRatio: '1:1',
            uploadedFile: null,
            imageBase64: null,
            lastPayload: null,
        };

        // DOM Elements
        const creationModeContainer = document.getElementById('creation-mode');
        const aiFocusContainer = document.getElementById('ai-focus');
        const aspectRatioContainer = document.getElementById('aspect-ratio');
        const styleSuggestionsContainer = document.getElementById('style-suggestions');
        const generateBtn = document.getElementById('generate-btn');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const imagePreview = document.getElementById('image-preview');
        const filenamePreview = document.getElementById('filename-preview');
        const previewContainer = document.getElementById('preview-container');
        const uploadPrompt = document.getElementById('upload-prompt');
        const descriptionInput = document.getElementById('description');
        
        // Result panel states
        const initialState = document.getElementById('initial-state');
        const loadingState = document.getElementById('loading-state');
        const loadingDetails = document.getElementById('loading-details');
        const errorState = document.getElementById('error-state');
        const errorMessage = document.getElementById('error-message');
        const resultState = document.getElementById('result-state');
        const resultImage = document.getElementById('result-image');
        
        // --- Event Listeners ---

        creationModeContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('mode-btn')) {
                handleSelection(creationModeContainer, e.target, 'creationMode', 'mode');
            }
        });

        aiFocusContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('focus-btn')) {
                handleSelection(aiFocusContainer, e.target, 'aiFocus', 'focus');
            }
        });

        aspectRatioContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.ratio-btn');
            if (button) {
                handleSelection(aspectRatioContainer, button, 'aspectRatio', 'ratio');
            }
        });

        styleSuggestionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('style-btn')) {
                const styleText = e.target.textContent;
                descriptionInput.value = (descriptionInput.value ? descriptionInput.value + ', ' : '') + styleText;
            }
        });
        
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            dropZone.addEventListener(eventName, () => dropZone.classList.toggle('dragover', ['dragenter', 'dragover'].includes(eventName)));
        });
        dropZone.addEventListener('drop', (e) => {
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFile(e.dataTransfer.files[0]);
            }
        });

        generateBtn.addEventListener('click', handleGenerate);

        // --- UI Functions ---

        function handleSelection(container, button, stateKey, dataKey) {
            container.querySelectorAll('button, .ratio-btn').forEach(btn => btn.classList.remove('btn-selected'));
            button.classList.add('btn-selected');
            state[stateKey] = button.dataset[dataKey];
        }

        function handleFile(file) {
            state.uploadedFile = file;
            filenamePreview.textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                state.imageBase64 = e.target.result.split(',')[1];
                imagePreview.src = e.target.result;
                uploadPrompt.classList.add('hidden');
                previewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function switchUIState(ui) {
            [initialState, loadingState, errorState, resultState].forEach(el => el.classList.add('hidden'));
            document.getElementById(`${ui}-state`).classList.remove('hidden');
        }
        
        function displayError(message, isRetriable = false) {
            switchUIState('error');
            errorMessage.textContent = message;
            
            const errorContainer = errorState.querySelector('div');
            let retryBtn = document.getElementById('retry-btn');
            if (retryBtn) retryBtn.remove();
            
            if (isRetriable && state.lastPayload) {
                retryBtn = document.createElement('button');
                retryBtn.id = 'retry-btn';
                retryBtn.className = 'mt-4 btn-secondary text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center mx-auto';
                retryBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.82-3.12M22 12.5a10 10 0 0 1-18.82 3.12"/></svg><span>Coba Lagi</span>`;
                retryBtn.onclick = () => callGeminiAPI(state.lastPayload);
                errorContainer.appendChild(retryBtn);
            }
        }

        // --- Core Logic ---

        async function handleGenerate() {
            if (!state.uploadedFile || !state.creationMode || !state.aiFocus || !state.aspectRatio) {
                displayError('Pastikan semua pilihan (Mode, Aset, Fokus, Rasio Aspek) sudah diisi.');
                return;
            }

            const userPrompt = descriptionInput.value.trim();
            if (!userPrompt) {
                displayError('Deskripsi imajinasi tidak boleh kosong.');
                return;
            }
            
            const payload = buildPayload(userPrompt);
            state.lastPayload = payload;
            await callGeminiAPI(payload);
        }
        
        function buildPayload(prompt) {
             const systemInstruction = `You are a world-class creative director. Generate an image based on the user's uploaded asset and their creative prompt.
            - Mode: ${state.creationMode}
            - AI Focus: ${state.aiFocus}
            - Aspect Ratio: ${state.aspectRatio}
            - User's creative idea: "${prompt}"`;

            return {
                contents: [{
                    parts: [
                        { text: systemInstruction },
                        { inlineData: { mimeType: state.uploadedFile.type, data: state.imageBase64 } }
                    ]
                }],
                 generationConfig: { responseModalities: ['IMAGE'] },
            };
        }

        async function callGeminiAPI(payload) {
            switchUIState('loading');
            loadingDetails.textContent = `Mode: ${state.creationMode}, Fokus: ${state.aiFocus}, Rasio: ${state.aspectRatio}`;

            try {
                // Menggunakan endpoint /api/gemini yang akan di-redirect oleh netlify.toml
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // URL API asli Google dikirim dalam body, bukan dipanggil langsung
                        apiUrl: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent',
                        payload: payload
                    })
                });

                const responseText = await response.text();
                if (!responseText) {
                    displayError('Server memberikan respons kosong. Ini mungkin karena timeout (proses lebih dari 26 detik). Coba sederhanakan prompt Anda.', true);
                    return;
                }

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                     displayError('Gagal memproses respons dari server. Respons tidak valid (bukan JSON).', false);
                     console.error("JSON Parse Error:", e, "Response Text:", responseText);
                     return;
                }


                if (!response.ok) {
                    let friendlyMessage = result.error || 'Terjadi kesalahan tidak diketahui.';
                    const isRateLimit = friendlyMessage.toLowerCase().includes('quota');
                    
                    if(isRateLimit) {
                         friendlyMessage = 'AI sedang sibuk karena batas penggunaan tercapai. Silakan coba lagi dalam satu menit.';
                    }
                    displayError(friendlyMessage, isRateLimit);
                    return;
                }

                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) {
                    displayError('Gagal mendapatkan gambar dari respons AI. Respon tidak valid.');
                    return;
                }

                resultImage.src = `data:image/png;base64,${base64Data}`;
                switchUIState('result');

            } catch (error) {
                console.error("Fetch error:", error);
                displayError(`Gagal terhubung ke server. Periksa koneksi Anda. Detail: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>

